<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity Web Player | KodomoEventBridge</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">

    
<!--Camera-->>
	<meta charset="utf-8">
	<title>denaripam_016_TeachingMaterials</title>
	<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.2.1617146986/drawing_utils.js" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.1.1617146909/camera_utils.js" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.1.1617147326/hands.js" crossorigin="anonymous"></script>

  </head>

  <body>

	<div id="detect_parent" class="container" style="position:relative; overflow:hidden;">
		<video class="input_video" style="width:1px; height:1px; opacity:0.0;"></video>
		<canvas class="output_canvas" width="320px" height="180px" style="transform:scale(-1,1);"></canvas>
	</div>

<script type="module">
const videoElement = document.getElementsByClassName('input_video')[0];
const canvasElement = document.getElementsByClassName('output_canvas')[0];
const canvasCtx = canvasElement.getContext('2d');

function onResults(results) {
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

    if (results.multiHandLandmarks) {
        for (const landmarks of results.multiHandLandmarks) {
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#0000FF', lineWidth: 5});
            drawLandmarks(canvasCtx, landmarks, {color: '#FF00FF', lineWidth: 2});

            const finger = 8; // index fingertip
            const chkpos = {
                x: 1 - landmarks[finger].x, // flip X for mirrored camera
                y: landmarks[finger].y,
                z: landmarks[finger].z
            };

            if (window.unityInstance) {
                window.unityInstance.SendMessage(
                    "JsReceiverObject",
                    "ReceiveVector3",
                    JSON.stringify(chkpos)
                );
            }
        }
    }
    canvasCtx.restore();
}

const hands = new Hands({locateFile: (file) => {
	return `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.1.1617147326/${file}`;
}});
hands.setOptions({
	maxNumHands: 1,
	minDetectionConfidence: 0.5,
	minTrackingConfidence: 0.5
});
hands.onResults(onResults);

const camera = new Camera(videoElement, {
	onFrame: async () => {
		await hands.send({image: videoElement});
	},
	width: 1280,
	height: 720
});
camera.start();
</script>

    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width=960 height=600 tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"> </div>
      <div id="unity-footer">
        <div id="unity-logo-title-footer"></div>
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">KodomoEventBridge</div>
      </div>
    </div>
    
   <script>
  var canvas = document.querySelector("#unity-canvas");

  function unityShowBanner(msg, type) {
    var warningBanner = document.querySelector("#unity-warning");
    function updateBannerVisibility() {
      warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
    }
    var div = document.createElement('div');
    div.innerHTML = msg;
    warningBanner.appendChild(div);
    if (type == 'error') div.style = 'background: red; padding: 10px;';
    else {
      if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
      setTimeout(function() {
        warningBanner.removeChild(div);
        updateBannerVisibility();
      }, 5000);
    }
    updateBannerVisibility();
  }

  var buildUrl = "Build";
  var loaderUrl = buildUrl + "/WEBGL.loader.js";
  var config = {
    arguments: [],
    dataUrl: buildUrl + "/WEBGL.data.br",
    frameworkUrl: buildUrl + "/WEBGL.framework.js.br",
    codeUrl: buildUrl + "/WEBGL.wasm.br",
    streamingAssetsUrl: "StreamingAssets",
    companyName: "DefaultCompany",
    productName: "KodomoEventBridge",
    productVersion: "0.1.0",
    showBanner: unityShowBanner,
  };

  if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
    var meta = document.createElement('meta');
    meta.name = 'viewport';
    meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
    document.getElementsByTagName('head')[0].appendChild(meta);
    document.querySelector("#unity-container").className = "unity-mobile";
    canvas.className = "unity-mobile";
  } else {
    canvas.style.width = "960px";
    canvas.style.height = "600px";
  }

  document.querySelector("#unity-loading-bar").style.display = "block";

  var script = document.createElement("script");
  script.src = loaderUrl;
  script.onload = () => {
    createUnityInstance(canvas, config, (progress) => {
      document.querySelector("#unity-progress-bar-full").style.width = 100 * progress + "%";
    }).then((unityInstance) => {
      document.querySelector("#unity-loading-bar").style.display = "none";
      document.querySelector("#unity-fullscreen-button").onclick = () => {
        unityInstance.SetFullscreen(1);
      };

      window.unityInstance = unityInstance;

    }).catch((message) => {
      alert(message);
    });
  };

  document.body.appendChild(script);
</script>


    
  </body>
</html>
